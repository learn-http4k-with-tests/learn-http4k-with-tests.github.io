<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Nat Pryce">
<title>Learn Http4k With Tests</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
<style>.toc-current{font-weight: bold;} .toc-root{font-family: "Open Sans","DejaVu Sans",sans-serif;
                       font-size: 0.9em;} #content{display: flex; flex-direction: column; flex: 1 1 auto;}
             .nav-footer{text-align: center; margin-top: auto;}
             .nav-footer > p > a {white-space: nowrap;}</style>
</head>
<body id="lenses" class="book toc2 toc-left">
<div id="header">
<h1>Learn Http4k With Tests</h1>
<div class="details">
<span id="author" class="author">Nat Pryce</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<p><span class="toc-root"><a href="book.html">Learn Http4k With Tests</a></span></p><ul class="sectlevel0">
<li><a href="introduction.html">Introduction</a>
</li>
<li><a href="fundamentals].html">I: The Fundamentals of Http4k</a>
<ul class="sectlevel1">
<li><a href="server-as-a-function.html">3. Server as a Function</a>
</li>
<li><a href="lenses.html"><span class="toc-current">4. Headers and Lenses</span></a>
<ul class="sectlevel2">
<li><a href="lenses.html#_convenient_extensions_of_request_and_response">4.1. Convenient Extensions of Request and Response</a>
</li>
<li><a href="lenses.html#_lenses">4.2. Lenses</a>
</li>
<li><a href="lenses.html#_defining_a_new_header_lens">4.3. Defining a New Header Lens</a>
</li>
</ul>
</li>
<li><a href="routing.html">5. Routing</a>
</li>
<li><a href="filters-and-stacks.html">6. Filters and stacks</a>
</li>
<li><a href="application-structure.html">7. Http4k Application Structure</a>
</li>
</ul>
</li>
<li><a href="realistic.html">II: Production Applications</a>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="lenses">4. Headers and Lenses</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_convenient_extensions_of_request_and_response">4.1. Convenient Extensions of Request and Response</h3>
<div class="paragraph">
<p>Our Hello World app doesn&#8217;t report the content type of the greeting it sends.  It should send a Content-Type header in the response to tell the client that the content is plain text.</p>
</div>
<div class="paragraph">
<p>http4k defines many convenient extension functions on Response, including extensions to get and set the Content-Type header.</p>
</div>
<div class="paragraph">
<p>Well &#8230;&#8203; not "set" but "return a new Response value that is a copy of the original Response value but with a Content-Type header with the given value". That&#8217;s quite a mouthful, so I&#8217;ll use keep using the word "set" as a shorthand, with the understanding that the operation transforms an immutable value rather than mutates state of a mutable object.</p>
</div>
<div class="paragraph">
<p>Anyway, we can add a check for the content type to the test of our app using the convenient getter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="nf">everyone`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">contentType</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>org.opentest4j.AssertionFailedError:
Expected :ContentType(value=text/plain, directives=[(charset, utf-8)])
Actual   :null</pre>
</div>
</div>
<div class="paragraph">
<p>We can make the test pass by using the extension that sets the Content-Type header.  http4k defines constants for many common content types as members of the companion object of the ContentType class, including the one we want: TEXT_PLAIN.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span> <span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">contentType</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lenses">4.2. Lenses</h3>
<div class="paragraph">
<p>The contentType helper functions are actually implemented using another fundamental concept of http4k: <em>lenses</em>. Lenses are often considered an advanced functional programming topic, but so much of http4k depends on them that we need to bite the bullet and understand how they work now. Don&#8217;t worry: the essential concept is pretty simple.</p>
</div>
<div class="paragraph">
<p>If we inline calls to the contentType extensions, we can see the lenses at work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="nf">everyone`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span> <span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A lens represents part of a structured type. For example, the Header.CONTENT_TYPE lens represents the value of the Content-Type header in an HttpMessage (the base type of Request or Response).</p>
</div>
<div class="paragraph">
<p>If you have a value of the structured type, you can treat the lens as a one-argument function that, when applied to a structure value, extracts the part from it. Our test applies the Header.CONTENT_TYPE lens to the Response to get the value of the Content-Type header of that Response.</p>
</div>
<div class="paragraph">
<p>You can also use a lens as a two-argument function, taking a part and a structure, that returns a new structure containing the part. Our app uses the Header.CONTENT_TYPE lens to combine a value for the Content-Type header and a Response without a Content-Type header to get a Response with a Content-Type header of the given value.</p>
</div>
<div class="paragraph">
<p>If that&#8217;s confusing, I would normally suggest taking a look at the type declarations, but http4k&#8217;s type declarations for lenses are quite complex, with a rich type hierarchy that is of help when you need to create new types of lens, but does get in the way of understanding the simple essence of lenses. Let&#8217;s instead use tests to build an intuition of how lenses behave.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">LensExample</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`lens</span> <span class="n">inject</span> <span class="n">and</span> <span class="n">extract</span> <span class="nf">example`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">lens</span> <span class="p">=</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span>

        <span class="kd">val</span> <span class="py">responseWithoutHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello, http4k"</span><span class="p">)</span>

        <span class="nf">assertNull</span><span class="p">(</span><span class="nf">lens</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">),</span>
            <span class="s">"the lens returns null when the header does not exist"</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">responseWithHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nf">lens</span><span class="p">(</span><span class="nc">ContentType</span><span class="p">(</span><span class="s">"application/example"</span><span class="p">),</span> <span class="n">responseWithoutHeader</span><span class="p">)</span>

        <span class="nf">assertNull</span><span class="p">(</span><span class="nf">lens</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">),</span>
            <span class="s">"the lens has not changed responseWithoutHeader"</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">ContentType</span><span class="p">(</span><span class="s">"application/example"</span><span class="p">),</span> <span class="nf">lens</span><span class="p">(</span><span class="n">responseWithHeader</span><span class="p">),</span>
            <span class="s">"the lens has created a new response with the header"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It should now be clear how our test is using the Header.CONTENT_TYPE lens to extract the value of the Content-Type header from the Response. But what are the <code>of</code> and <code>with(&#8230;&#8203;)</code> operations doing in the app? Let&#8217;s use more tests to see what they do.</p>
</div>
<div class="paragraph">
<p><code>Of</code> is an infix extension that binds the first argument of the lens' two-argument setter function, returning a one-argument setter function that always sets the same value of the part.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`of</span> <span class="n">creates</span> <span class="n">a</span> <span class="n">setter</span> <span class="n">function</span> <span class="n">bound</span> <span class="n">to</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">part</span> <span class="nf">value`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">textPlainContentTypeSetter</span><span class="p">:</span> <span class="p">(</span><span class="nc">Response</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Response</span> <span class="p">=</span>
        <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span>

    <span class="kd">val</span> <span class="py">responseWithoutHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello, http4k"</span><span class="p">)</span>

    <span class="kd">val</span> <span class="py">responseWithHeader</span> <span class="p">=</span> <span class="nf">textPlainContentTypeSetter</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">)</span>

    <span class="nf">assertNull</span><span class="p">(</span><span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">),</span>
        <span class="s">"the lens has not changed responseWithoutHeader"</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">responseWithHeader</span><span class="p">),</span>
        <span class="s">"the setter has created a new response with the header"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>With</code> is syntactic sugar that applies one or more bound setters to a structure in one call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`with</span> <span class="n">applies</span> <span class="n">one</span> <span class="n">or</span> <span class="n">more</span> <span class="n">bound</span> <span class="n">setter</span> <span class="nf">functions`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">responseWithoutHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello, http4k"</span><span class="p">)</span>

    <span class="kd">val</span> <span class="py">textPlainContentTypeHeader</span><span class="p">:</span> <span class="p">(</span><span class="nc">Response</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Response</span> <span class="p">=</span>
        <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span>
    <span class="kd">val</span> <span class="py">canonicalLinkHeader</span> <span class="p">:</span> <span class="p">(</span><span class="nc">Response</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Response</span> <span class="p">=</span>
        <span class="nc">Header</span><span class="p">.</span><span class="nc">LINK</span> <span class="n">of</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"canonical"</span> <span class="n">to</span> <span class="nc">Uri</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="s">"/hello"</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">responseWithHeaders</span> <span class="p">=</span> <span class="n">responseWithoutHeader</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="n">textPlainContentTypeHeader</span><span class="p">,</span> <span class="n">canonicalLinkHeader</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span>
        <span class="n">responseWithHeaders</span><span class="p">,</span>
        <span class="nf">canonicalLinkHeader</span><span class="p">(</span><span class="nf">textPlainContentTypeHeader</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">)),</span>
        <span class="s">"with and of are more readable than using lenses as functions"</span>
    <span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span>
        <span class="n">actual</span> <span class="p">=</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">responseWithHeaders</span><span class="p">),</span>
        <span class="n">expected</span> <span class="p">=</span> <span class="nc">TEXT_PLAIN</span><span class="p">,</span>
        <span class="n">message</span> <span class="p">=</span> <span class="s">"the new response has the Content-Type header"</span>
    <span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span>
        <span class="n">actual</span> <span class="p">=</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">LINK</span><span class="p">(</span><span class="n">responseWithHeaders</span><span class="p">),</span>
        <span class="n">expected</span> <span class="p">=</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"canonical"</span> <span class="n">to</span> <span class="nc">Uri</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="s">"/hello"</span><span class="p">)),</span>
        <span class="n">message</span> <span class="p">=</span> <span class="s">"the new response has the Location header"</span>
    <span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Together <code>with</code> and <code>of</code> make code that uses lenses to set values easier to read. If we used lenses as functions in our code, we would end up with deeply nested function calls and lots of parentheses. Using <code>with</code> and <code>of</code> we avoid all the parentheses and our code refers to the lenses and values in an order that reads more naturally.</p>
</div>
</div>
<div class="sect2">
<h3 id="_defining_a_new_header_lens">4.3. Defining a New Header Lens</h3>
<div class="paragraph">
<p>Let&#8217;s also signal that our app&#8217;s greeting is in English by sending the Content-Language response header.
Here&#8217;s our test extended to include the behaviour we want:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="nf">everyone`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That test doesn&#8217;t even compile.  http4k doesn&#8217;t have a lens for the Content-Language header. We will need to write it ourselves.</p>
</div>
<div class="paragraph">
<p>We could define it as a top-level constant in our app, but http4k&#8217;s naming convention is to group lenses by the part of the HttpMessage that they refer to: Body, Header, Path, Query, etc.
If we are working in a team, or publishing a library, following this convention will help other developers find our new lens with autocomplete in the IDE.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="chapters/autocomplete-including-custom-lens.png" alt="Autocomplete includes our custom header lens">
</div>
</div>
<div class="paragraph">
<p>We can follow http4k&#8217;s naming convention by writing our lens as extension of the Header object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nc">Locale</span><span class="o">::</span><span class="n">forLanguageTag</span><span class="p">,</span> <span class="nc">Locale</span><span class="o">::</span><span class="n">toLanguageTag</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">optional</span><span class="p">(</span><span class="s">"content-language"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As well as being a scope for header lenses, the Header object is a partially defined lens that represents some value of type String within the headers of an HttpMessage.  Partially defined, because to be a fully defined lens that targets a specific header, it needs the name of the header. This is what the call to <code>optional</code> does.  The <code>map</code> method turns the (partially defined) lens for a String into a lens for a Locale by mapping in both directions between String and Locale. The mapping is defined by two functions.  The function of type <code>(String)&#8594;Locale</code> is used when getting the header value.  The function of <code>(Locale)&#8594;String</code> is used when setting the header value.</p>
</div>
<div class="paragraph">
<p>My brain finds that, http4k&#8217;s lens declarations read backwards. I would find an API like <code>Header.named("content-language").map(&#8230;&#8203;).optional()</code> easier to understand, but the API is what it is, and it works. As an author I struggle to explain it well (sorry about that!), but as a developer I can define new types of lens very easily and succinctly. And when you use http4k, you define new lenses a <em>lot</em>!</p>
</div>
<div class="paragraph">
<p>With the definition of the CONTENT_LANGUAGE lens, our test compiles, and now fails as we expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">HelloWorldTest &gt; returns hello everyone() FAILED
org.opentest4j.AssertionFailedError: expected: &lt;en&gt; but was: &lt;null&gt;
	at app//learnhttp4kwithtests.HelloWorldTest.returns hello everyone(HelloWorldTest.kt:21)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can make it pass by using the lens to set the header value in the <code>with</code> call in our main app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span><span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span>
            <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">,</span>
            <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="n">of</span> <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now our test passes.</p>
</div>
<div class="paragraph">
<p>We can make a small optimisation, to avoid constructing a new lens value every time we refer to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">private</span> <span class="kd">val</span> <span class="py">contentLanguageLens</span> <span class="p">=</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nc">Locale</span><span class="o">::</span><span class="n">forLanguageTag</span><span class="p">,</span> <span class="nc">Locale</span><span class="o">::</span><span class="n">toLanguageTag</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">optional</span><span class="p">(</span><span class="s">"content-language"</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">contentLanguageLens</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our test still passes.</p>
</div>
<div class="paragraph">
<p>And the Kotlin compiler will generate the backing field and getter function for us if we define the extension using property delegation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="k">by</span> <span class="nf">lazyOf</span><span class="p">(</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nc">Locale</span><span class="o">::</span><span class="n">forLanguageTag</span><span class="p">,</span> <span class="nc">Locale</span><span class="o">::</span><span class="n">toLanguageTag</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">optional</span><span class="p">(</span><span class="s">"content-language"</span><span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>lazyOf</code> function in Kotlin&#8217;s standard library actually creates a property delegate for an eagerly constructed value!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is the most concise and efficient way I know to define extension properties, so we&#8217;ll use this idiom for any more that we need.</p>
</div>
</div>
</div>
</div>
<div class="paragraph nav-footer">
<p>Previous:<a href="server-as-a-function.html">Server as a Function</a>| Up:<a href="fundamentals].html">The Fundamentals of Http4k</a>| Home:<a href="book.html">Learn Http4k With Tests</a>| Next:<a href="routing.html">Routing</a></p>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-09-05 13:47:08 +0100
</div>
</div>
</body>
</html>