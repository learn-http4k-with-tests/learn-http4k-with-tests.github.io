<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.23">
<meta name="author" content="Nat Pryce">
<title>Learn Http4k With Tests</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child{border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active,#footnotes .footnote a:first-of-type:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge, pre.rouge .w {
  color: #24292f;
  background-color: #f6f8fa;
}
pre.rouge .k, pre.rouge .kd, pre.rouge .kn, pre.rouge .kp, pre.rouge .kr, pre.rouge .kt, pre.rouge .kv {
  color: #cf222e;
}
pre.rouge .gr {
  color: #f6f8fa;
}
pre.rouge .gd {
  color: #82071e;
  background-color: #ffebe9;
}
pre.rouge .nb {
  color: #953800;
}
pre.rouge .nc {
  color: #953800;
}
pre.rouge .no {
  color: #953800;
}
pre.rouge .nn {
  color: #953800;
}
pre.rouge .sr {
  color: #116329;
}
pre.rouge .na {
  color: #116329;
}
pre.rouge .nt {
  color: #116329;
}
pre.rouge .gi {
  color: #116329;
  background-color: #dafbe1;
}
pre.rouge .ges {
  font-weight: bold;
  font-style: italic;
}
pre.rouge .kc {
  color: #0550ae;
}
pre.rouge .l, pre.rouge .ld, pre.rouge .m, pre.rouge .mb, pre.rouge .mf, pre.rouge .mh, pre.rouge .mi, pre.rouge .il, pre.rouge .mo, pre.rouge .mx {
  color: #0550ae;
}
pre.rouge .sb {
  color: #0550ae;
}
pre.rouge .bp {
  color: #0550ae;
}
pre.rouge .ne {
  color: #0550ae;
}
pre.rouge .nl {
  color: #0550ae;
}
pre.rouge .py {
  color: #0550ae;
}
pre.rouge .nv, pre.rouge .vc, pre.rouge .vg, pre.rouge .vi, pre.rouge .vm {
  color: #0550ae;
}
pre.rouge .o, pre.rouge .ow {
  color: #0550ae;
}
pre.rouge .gh {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .gu {
  color: #0550ae;
  font-weight: bold;
}
pre.rouge .s, pre.rouge .sa, pre.rouge .sc, pre.rouge .dl, pre.rouge .sd, pre.rouge .s2, pre.rouge .se, pre.rouge .sh, pre.rouge .sx, pre.rouge .s1, pre.rouge .ss {
  color: #0a3069;
}
pre.rouge .nd {
  color: #8250df;
}
pre.rouge .nf, pre.rouge .fm {
  color: #8250df;
}
pre.rouge .err {
  color: #f6f8fa;
  background-color: #82071e;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cm, pre.rouge .cp, pre.rouge .cpf, pre.rouge .c1, pre.rouge .cs {
  color: #6e7781;
}
pre.rouge .gl {
  color: #6e7781;
}
pre.rouge .gt {
  color: #6e7781;
}
pre.rouge .ni {
  color: #24292f;
}
pre.rouge .si {
  color: #24292f;
}
pre.rouge .ge {
  color: #24292f;
  font-style: italic;
}
pre.rouge .gs {
  color: #24292f;
  font-weight: bold;
}
</style>
</head>
<body class="book">
<div id="header">
<h1>Learn Http4k With Tests</h1>
<div class="details">
<span id="author" class="author">Nat Pryce</span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel0">
<li><a href="#introduction">Introduction</a>
<ul class="sectlevel1">
<li><a href="#about">1. About This Book</a></li>
<li><a href="#acknowledgements">2. Acknowlegements</a></li>
<li><a href="#build">3. Setting up the Build</a></li>
</ul>
</li>
<li><a href="#fundamentals]">I: The Fundamentals of Http4k</a>
<ul class="sectlevel1">
<li><a href="#server-as-a-function">4. Server as a Function</a>
<ul class="sectlevel2">
<li><a href="#_request_response_and_httphandler">4.1. Request, Response and HttpHandler</a></li>
<li><a href="#_running_our_app_in_a_server">4.2. Running our App in a Server</a></li>
<li><a href="#_testing_our_app">4.3. Testing our App</a></li>
<li><a href="#_immutability">4.4. Immutability</a></li>
</ul>
</li>
<li><a href="#lenses">5. Headers and Lenses</a>
<ul class="sectlevel2">
<li><a href="#_convenient_extensions_of_request_and_response">5.1. Convenient Extensions of Request and Response</a></li>
<li><a href="#_lenses">5.2. Lenses</a></li>
<li><a href="#_defining_a_new_header_lens">5.3. Defining a New Header Lens</a></li>
</ul>
</li>
<li><a href="#routing">6. Routing</a>
<ul class="sectlevel2">
<li><a href="#_routing_requests_to_handlers">6.1. Routing Requests to Handlers</a></li>
<li><a href="#_extracting_values_from_a_request">6.2. Extracting Values from a Request</a></li>
<li><a href="#_routing_different_methods_to_a_resource">6.3. Routing different methods to a resource</a></li>
</ul>
</li>
<li><a href="#filters-and-stacks">7. Filters and stacks</a>
<ul class="sectlevel2">
<li><a href="#_other_useful_filters">7.1. Other Useful Filters</a></li>
<li><a href="#_writing_a_filter">7.2. Writing a filter</a></li>
</ul>
</li>
<li><a href="#application-structure">8. Http4k Application Structure</a></li>
</ul>
</li>
<li><a href="#realistic">II: Production Applications</a>
<ul class="sectlevel1">
<li><a href="#functional-test">9. Writing a Functional Test</a></li>
<li><a href="#json">10. JSON serialisation</a></li>
<li><a href="#configuration">11. Configuration</a></li>
<li><a href="#persistence">12. Persistence and transactions</a></li>
<li><a href="#http-clients">13. HTTP Clients</a></li>
<li><a href="#error-handling">14. Error handling</a></li>
<li><a href="#monitoring">15. Monitoring and alerting</a></li>
<li><a href="#authentication">16. OAuth, Authentication and Authorisation</a></li>
<li><a href="#background-tasks">17. Transactional outboxes and background tasks</a></li>
<li><a href="#resilience">18. Resilience</a></li>
<li><a href="#contracts">19. Contracts and OpenAPI</a></li>
<li><a href="#frontend">20. Front End: HTML, HTMX, &amp; templates</a></li>
<li><a href="#multiservice">21. Multiservice applications</a></li>
<li><a href="#streaming">22. File uploads and streaming content</a></li>
<li><a href="#api-evolution">23. API evolution</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<h1 id="introduction" class="sect0">Introduction</h1>
<div class="sect1">
<h2 id="about">1. About This Book</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TBD</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="acknowledgements">2. Acknowlegements</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Thank you to  Chris James (AKA Quii), who came up with the catchy "Learn &lt;thing&gt; with tests" name and kindly allowed me to reuse it for http4k. Check out his book, <a href="https://quii.gitbook.io/learn-go-with-tests">Learn Go With Tests</a>, for an introduction to programming, and testing, in the Go language.</p>
</div>
<div class="paragraph">
<p>Thanks to Dave Denton and Ivan Sanchez, authors of http4k, for answering my questions about how and why http4k works the way it does.</p>
</div>
<div class="paragraph">
<p>Thanks to
Dave Denton,
and Michael W,
for reviewing early versions of the book and giving helpful feedback.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="build">3. Setting up the Build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before we can start writing http4k web apps, we need a Kotlin build that includes the http4k dependencies.</p>
</div>
<div class="paragraph">
<p>I&#8217;m assuming that you use Gradle: at the time of writing it&#8217;s the default build tool for Kotlin projects. I&#8217;m also assuming that you&#8217;re writing your Gradle build scripts in Kotlin, not Groovy: at the time of writing it&#8217;s the default syntax for Gradle builds. To get started quickly, you can get IntelliJ to create a new Kotlin JVM project and it will generate a working Gradle build script to which you can add the http4k dependencies.</p>
</div>
<div class="paragraph">
<p>Add the following dependencies to bring in the core http4k module:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">implementation</span><span class="p">(</span><span class="nf">platform</span><span class="p">(</span><span class="s">"org.http4k:http4k-bom:6.17.0.0"</span><span class="p">))</span>
<span class="nf">implementation</span><span class="p">(</span><span class="s">"org.http4k:http4k-core"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re used to Java frameworks like Spring Boot, you&#8217;ll find that http4k has a quite different philosophy. Spring Boot follows a "batteries included" approach. It includes a large number of dependencies by default. Its behaviour can depend on what it finds on the classpath at runtime, which makes getting started easy but can lead to surprises as a project grows.  http4k may be characterised as "batteries readily available".  It has a small core that has no dependencies beyond the Kotlin standard library and lots of optional modules, most of which bring in additional dependencies. Applications explicitly depend <em>only</em> on the modules they actually need. http4k will not activate features if a module happens to be on the classpath. Applications have to explicitly compose into their application the features they want to use from http4k&#8217;s modules.</p>
</div>
<div class="paragraph">
<p>The http4k project publishes versions of the toolkit as a "bill of materials" (BOM) that specifies consistent versions of all the http4k modules and their transitive dependencies. In your build script, you depend on a specific version of the BOM as a platform dependency, and then you don&#8217;t need to specif the versions of each http4k module your project uses.  When a new http4k version is released, you only need to change the version of the BOM to upgrade all the http4k modules in your project.  http4k releases quite frequently (sometimes multiple times a day!), but upgrades are easy to adopt and because the http4k API is very narrow, new versions seldom require source code changes.</p>
</div>
<div class="paragraph">
<p>As we continue through the book, we will add dependencies on other http4k modules as needed, but this is enough to be able to write our first http4k application. However, it&#8217;s not enough for us to be able to <em>test</em> our first http4k application. For testing, we will add the <code>kotlin-test-junit5</code> module of the Kotlin standard library:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">testImplementation</span><span class="p">(</span><span class="nf">kotlin</span><span class="p">(</span><span class="s">"test-junit5"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s the entire Gradle build file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">plugins</span> <span class="p">{</span>
    <span class="nf">kotlin</span><span class="p">(</span><span class="s">"jvm"</span><span class="p">)</span> <span class="n">version</span> <span class="s">"2.2.10"</span>
<span class="p">}</span>

<span class="nf">repositories</span> <span class="p">{</span>
    <span class="nf">mavenCentral</span><span class="p">()</span>
<span class="p">}</span>

<span class="nf">dependencies</span> <span class="p">{</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="nf">platform</span><span class="p">(</span><span class="s">"org.http4k:http4k-bom:6.17.0.0"</span><span class="p">))</span>
    <span class="nf">implementation</span><span class="p">(</span><span class="s">"org.http4k:http4k-core"</span><span class="p">)</span>

    <span class="nf">testImplementation</span><span class="p">(</span><span class="nf">kotlin</span><span class="p">(</span><span class="s">"test-junit5"</span><span class="p">))</span>
<span class="p">}</span>

<span class="n">tasks</span><span class="p">.</span><span class="nf">test</span> <span class="p">{</span>
    <span class="nf">useJUnitPlatform</span><span class="p">()</span>
<span class="p">}</span>

<span class="nf">kotlin</span> <span class="p">{</span>
    <span class="nf">jvmToolchain</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now letâ€™s write a Hello World app to check our build script works and start exploring the http4k API.</p>
</div>
</div>
</div>
<h1 id="fundamentals]" class="sect0">I: The Fundamentals of Http4k</h1>
<div class="openblock partintro">
<div class="content">
<div class="paragraph">
<p>In this part, we examine the fundamental concepts in http4k, by writing a tiny Hello World application. This will give us the foundations we need for <a href="#realistic">Part II, &#8220;Production Applications&#8221;</a>, that looks at how http4k meets the needs of production applications.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="server-as-a-function">4. Server as a Function</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_request_response_and_httphandler">4.1. Request, Response and HttpHandler</h3>
<div class="paragraph">
<p>Let&#8217;s jump straight in. Here&#8217;s "Hello World" in http4k:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span> <span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello, world"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>An http4k application is a value of type HttpHandler, which is a function from Request to Response.</p>
</div>
<div class="paragraph">
<p>You can navigate to the definition of HttpHandler in IntelliJ and see that it is nothing more than a function:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">typealias</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="nc">Request</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Response</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Almost everything an http4k web app must do is implemented by functions of HttpHandler functions. Routing? Functions. Content negotiation? Functions. Views and templates? Functions. I could go on&#8230;&#8203; and I will! Authentication? Functions. Error handling? Functions. Observability? Functions. HTTP clients? Functions. Resilience? Functions. OK, I&#8217;ll stop now. If you have a question, the answer is usually "Functions!" and those functions usually take a Request and return a Response, or compose functions that take a Request and return a Response into a new function that takes a Request and returns a Response.</p>
</div>
<div class="paragraph">
<p>The HttpHandler for our Hello World app doesn&#8217;t do anything with the request (yet), and returns a Response with a status of 200 OK and a body of the text "hello, world".</p>
</div>
<div class="paragraph">
<p>It&#8217;s conventional to define an HttpHandler as a lambda, not a named function to make it easier to pass it around as a value. If declared as a named function we would have to refer to the handler <em>value</em> as <code>::app</code> instead of <code>app</code>.  http4k apps use HttpHandlers as first-class values extensively. They store them in variables, pass them into functions as parameters, return them from functions as results, and compose them with other HttpHandler functions to form new HttpHandler functions.</p>
</div>
</div>
<div class="sect2">
<h3 id="_running_our_app_in_a_server">4.2. Running our App in a Server</h3>
<div class="paragraph">
<p>To run our application, we need to launch it in a Server. A Server exposes the app on the network and translates between on-the-wire HTTP communication and http4k&#8217;s "server as a function" model. The http-core module contains a server implementation that uses the HttpServer class of the JDK, but that&#8217;s only suitable for local development and experiments. For production use, you can choose one of the server modules listed at <a href="https://www.http4k.org/ecosystem/http4k/reference/servers/" class="bare">https://www.http4k.org/ecosystem/http4k/reference/servers/</a> that is a good fit for your production environment.  In this book we will use Jetty with Java&#8217;s virtual threads.</p>
</div>
<div class="paragraph">
<p>First, we must add a dependency on the http4k-server-jetty module to our build file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nf">implementation</span><span class="p">(</span><span class="s">"org.http4k:http4k-server-jetty"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we can write a main function for our app that calls the <code>asServer</code> extension to turn the application handler into a Jetty server, and starts it serving requests.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">app</span><span class="p">.</span><span class="nf">asServer</span><span class="p">(</span><span class="nc">JettyLoom</span><span class="p">(</span><span class="n">port</span><span class="p">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">also</span> <span class="p">{</span>
            <span class="nf">println</span><span class="p">(</span><span class="s">"http://localhost:${it.port()}"</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If we click on the URL that is output (or copy and paste it into the address bar of a web browser) we can see the output of the application:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="chapters/hello-world-browser.png" alt="A browser displaying the text &quot;hello, world&quot;">
</div>
</div>
<div class="paragraph">
<p>Passing port zero to the JettyLoom server configuration makes the server use a free port allocated by the operating system, so the port number you will see when you run the server will probably be different to the one in the screenshot. We will look at how to configure the port (and other properties of our application) in <a href="#configuration">Chapter 11, <em>Configuration</em></a>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_testing_our_app">4.3. Testing our App</h3>
<div class="paragraph">
<p>An http4k app is just a function, and Requests and Responses are immutable values. That makes http4k apps very easy to test.  We don&#8217;t need to spin up a server and use an HTTP client library to send requests to it.  We don&#8217;t need to configure a special "mock" environment for testing with subtle differences to the real thing.  Our tests can just call the function. This makes them fast and reliable.</p>
</div>
<div class="paragraph">
<p>As an application grows, it becomes convenient to write higher-level abstractions that abstract over the HTTP client. http4k models HTTP clients, like servers, as functions of type HttpHandler. To implement a server-side app you write an HttpHandler that receives a Request parameter and returns a Response. To use a client, you call the HttpHandler, passing a Request parameter and receive a Response as a result. We can compose code that would use an HTTP client to talk to an app directly with the HttpHandler of the app to test the integration of the two, and still get very fast, reliable tests that run entirely in memory.  We will look at this in detail in <a href="#http-clients">Chapter 13, <em>HTTP Clients</em></a>. Given how small our app is at the moment, it is not a problem to call our app directly in the test.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a test that verifies our app returns a body of "hello, http4k":</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="nf">everyone`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;d expect that test to fail: our app actually returns "hello, world". By starting with a failing test, we confirm that our test is actually testing what we want it to, that we&#8217;re not getting false positives, and that the failure diagnostics are good enough.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">HelloWorldTest &gt; returns hello everyone() FAILED
org.opentest4j.AssertionFailedError: expected: &lt;hello everyone&gt; but was: &lt;hello, world&gt;
	at app//learnhttp4kwithtests.HelloWorldTest.returns hello everyone(HelloWorldTest.kt:16)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can make the test pass by changing our app to match:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span> <span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We&#8217;ve bootstrapped a test-driven development process.
From now on, we will write the tests first, check they fail for the reason we expect, discuss anything interesting about the error messages, and then implement code to make the tests pass.</p>
</div>
</div>
<div class="sect2">
<h3 id="_immutability">4.4. Immutability</h3>
<div class="paragraph">
<p>Requests and Responses are immutable values. The <code>body</code> operation called by our app does not <em>set</em> the body of the Response but returns a <em>new</em> Response value with the given body.</p>
</div>
<div class="paragraph">
<p>Compare immutable and here&#8217;s a test of code using the http4k API to define common properties for Requests and then derive two actual Requests with those common properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">commonProperties</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"http://example.com"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">accept</span><span class="p">(</span><span class="nc">APPLICATION_JSON</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">r1</span> <span class="p">=</span> <span class="n">commonProperties</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="s">"Bearer token-1"</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">r2</span> <span class="p">=</span> <span class="n">commonProperties</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="s">"Bearer token-2"</span><span class="p">)</span>

<span class="nf">assertEquals</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="s">"Bearer token-1"</span><span class="p">),</span> <span class="n">r1</span><span class="p">.</span><span class="nf">headerValues</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">))</span>
<span class="nf">assertEquals</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="s">"Bearer token-2"</span><span class="p">),</span> <span class="n">r2</span><span class="p">.</span><span class="nf">headerValues</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">))</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This test passes.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a test of similar code written with Spring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">commonProperties</span> <span class="p">=</span> <span class="nc">RequestEntity</span><span class="p">.</span><span class="nf">method</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"http://example.com"</span><span class="p">)</span>
    <span class="p">.</span><span class="nf">accept</span><span class="p">(</span><span class="nc">APPLICATION_JSON</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">r1</span> <span class="p">=</span> <span class="n">commonProperties</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="s">"Bearer token-1"</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>
<span class="kd">val</span> <span class="py">r2</span> <span class="p">=</span> <span class="n">commonProperties</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"Authorization"</span><span class="p">,</span> <span class="s">"Bearer token-2"</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="k">null</span><span class="p">)</span>

<span class="nf">assertEquals</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="s">"Bearer token-1"</span><span class="p">),</span> <span class="n">r1</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Authorization"</span><span class="p">])</span>
<span class="nf">assertEquals</span><span class="p">(</span><span class="nf">listOf</span><span class="p">(</span><span class="s">"Bearer token-2"</span><span class="p">),</span> <span class="n">r2</span><span class="p">.</span><span class="n">headers</span><span class="p">[</span><span class="s">"Authorization"</span><span class="p">])</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This test fails with the error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>Expected :[Bearer token-1]
Actual   :[Bearer token-1, Bearer token-2]</pre>
</div>
</div>
<div class="paragraph">
<p>In the Spring code, the object refered to by <em>commonProperties</em> is mutable. The lines that calculate <em>r1</em> and <em>r2</em> mutate that object. State leaks between <em>r1</em> and <em>r2</em> without the data flow being is visible in the source code.</p>
</div>
<div class="paragraph">
<p>Immutability makes data flow in http4k applications explicit and easy to follow with IntelliJ&#8217;s code navigation tools. There is no mutable state that allows the kind of "spooky action at a distance" possible with the Spring APIs. However, working with immutable data is a lot easier if we are familiar with another fundamental mechanism in http4k, lenses, so we will look at them next, in <a href="#lenses">Chapter 5, <em>Headers and Lenses</em></a>.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="lenses">5. Headers and Lenses</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_convenient_extensions_of_request_and_response">5.1. Convenient Extensions of Request and Response</h3>
<div class="paragraph">
<p>Our Hello World app doesn&#8217;t report the content type of the greeting it sends.  It should send a Content-Type header in the response to tell the client that the content is plain text.</p>
</div>
<div class="paragraph">
<p>http4k defines many convenient extension functions on Response, including extensions to get and set the Content-Type header.</p>
</div>
<div class="paragraph">
<p>Well &#8230;&#8203; not "set" but "return a new Response value that is a copy of the original Response value but with a Content-Type header with the given value". That&#8217;s quite a mouthful, so I&#8217;ll use keep using the word "set" as a shorthand, with the understanding that the operation transforms an immutable value rather than mutates state of a mutable object.</p>
</div>
<div class="paragraph">
<p>Anyway, we can add a check for the content type to the test of our app using the convenient getter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="nf">everyone`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">contentType</span><span class="p">())</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre>org.opentest4j.AssertionFailedError:
Expected :ContentType(value=text/plain, directives=[(charset, utf-8)])
Actual   :null</pre>
</div>
</div>
<div class="paragraph">
<p>We can make the test pass by using the extension that sets the Content-Type header.  http4k defines constants for many common content types as members of the companion object of the ContentType class, including the one we want: TEXT_PLAIN.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span> <span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">contentType</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_lenses">5.2. Lenses</h3>
<div class="paragraph">
<p>The contentType helper functions are actually implemented using another fundamental concept of http4k: <em>lenses</em>. Lenses are often considered an advanced functional programming topic, but so much of http4k depends on them that we need to bite the bullet and understand how they work now. Don&#8217;t worry: the essential concept is pretty simple.</p>
</div>
<div class="paragraph">
<p>If we inline calls to the contentType extensions, we can see the lenses at work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="nf">everyone`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span> <span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>A lens represents part of a structured type. For example, the Header.CONTENT_TYPE lens represents the value of the Content-Type header in an HttpMessage (the base type of Request or Response).</p>
</div>
<div class="paragraph">
<p>If you have a value of the structured type, you can treat the lens as a one-argument function that, when applied to a structure value, extracts the part from it. Our test applies the Header.CONTENT_TYPE lens to the Response to get the value of the Content-Type header of that Response.</p>
</div>
<div class="paragraph">
<p>You can also use a lens as a two-argument function, taking a part and a structure, that returns a new structure containing the part. Our app uses the Header.CONTENT_TYPE lens to combine a value for the Content-Type header and a Response without a Content-Type header to get a Response with a Content-Type header of the given value.</p>
</div>
<div class="paragraph">
<p>If that&#8217;s confusing, I would normally suggest taking a look at the type declarations, but http4k&#8217;s type declarations for lenses are quite complex, with a rich type hierarchy that is of help when you need to create new types of lens, but does get in the way of understanding the simple essence of lenses. Let&#8217;s instead use tests to build an intuition of how lenses behave.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">LensExample</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`lens</span> <span class="n">inject</span> <span class="n">and</span> <span class="n">extract</span> <span class="nf">example`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">lens</span> <span class="p">=</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span>

        <span class="kd">val</span> <span class="py">responseWithoutHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello, http4k"</span><span class="p">)</span>

        <span class="nf">assertNull</span><span class="p">(</span><span class="nf">lens</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">),</span>
            <span class="s">"the lens returns null when the header does not exist"</span><span class="p">)</span>

        <span class="kd">val</span> <span class="py">responseWithHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nf">lens</span><span class="p">(</span><span class="nc">ContentType</span><span class="p">(</span><span class="s">"application/example"</span><span class="p">),</span> <span class="n">responseWithoutHeader</span><span class="p">)</span>

        <span class="nf">assertNull</span><span class="p">(</span><span class="nf">lens</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">),</span>
            <span class="s">"the lens has not changed responseWithoutHeader"</span><span class="p">)</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">ContentType</span><span class="p">(</span><span class="s">"application/example"</span><span class="p">),</span> <span class="nf">lens</span><span class="p">(</span><span class="n">responseWithHeader</span><span class="p">),</span>
            <span class="s">"the lens has created a new response with the header"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>It should now be clear how our test is using the Header.CONTENT_TYPE lens to extract the value of the Content-Type header from the Response. But what are the <code>of</code> and <code>with(&#8230;&#8203;)</code> operations doing in the app? Let&#8217;s use more tests to see what they do.</p>
</div>
<div class="paragraph">
<p><code>Of</code> is an infix extension that binds the first argument of the lens' two-argument setter function, returning a one-argument setter function that always sets the same value of the part.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`of</span> <span class="n">creates</span> <span class="n">a</span> <span class="n">setter</span> <span class="n">function</span> <span class="n">bound</span> <span class="n">to</span> <span class="n">a</span> <span class="n">specific</span> <span class="n">part</span> <span class="nf">value`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">textPlainContentTypeSetter</span><span class="p">:</span> <span class="p">(</span><span class="nc">Response</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Response</span> <span class="p">=</span>
        <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span>

    <span class="kd">val</span> <span class="py">responseWithoutHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello, http4k"</span><span class="p">)</span>

    <span class="kd">val</span> <span class="py">responseWithHeader</span> <span class="p">=</span> <span class="nf">textPlainContentTypeSetter</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">)</span>

    <span class="nf">assertNull</span><span class="p">(</span><span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">),</span>
        <span class="s">"the lens has not changed responseWithoutHeader"</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">responseWithHeader</span><span class="p">),</span>
        <span class="s">"the setter has created a new response with the header"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><code>With</code> is syntactic sugar that applies one or more bound setters to a structure in one call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`with</span> <span class="n">applies</span> <span class="n">one</span> <span class="n">or</span> <span class="n">more</span> <span class="n">bound</span> <span class="n">setter</span> <span class="nf">functions`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">responseWithoutHeader</span><span class="p">:</span> <span class="nc">Response</span> <span class="p">=</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">).</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello, http4k"</span><span class="p">)</span>

    <span class="kd">val</span> <span class="py">textPlainContentTypeHeader</span><span class="p">:</span> <span class="p">(</span><span class="nc">Response</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Response</span> <span class="p">=</span>
        <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span>
    <span class="kd">val</span> <span class="py">canonicalLinkHeader</span> <span class="p">:</span> <span class="p">(</span><span class="nc">Response</span><span class="p">)</span> <span class="p">-&gt;</span> <span class="nc">Response</span> <span class="p">=</span>
        <span class="nc">Header</span><span class="p">.</span><span class="nc">LINK</span> <span class="n">of</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"canonical"</span> <span class="n">to</span> <span class="nc">Uri</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="s">"/hello"</span><span class="p">))</span>

    <span class="kd">val</span> <span class="py">responseWithHeaders</span> <span class="p">=</span> <span class="n">responseWithoutHeader</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="n">textPlainContentTypeHeader</span><span class="p">,</span> <span class="n">canonicalLinkHeader</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span>
        <span class="n">responseWithHeaders</span><span class="p">,</span>
        <span class="nf">canonicalLinkHeader</span><span class="p">(</span><span class="nf">textPlainContentTypeHeader</span><span class="p">(</span><span class="n">responseWithoutHeader</span><span class="p">)),</span>
        <span class="s">"with and of are more readable than using lenses as functions"</span>
    <span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span>
        <span class="n">actual</span> <span class="p">=</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">responseWithHeaders</span><span class="p">),</span>
        <span class="n">expected</span> <span class="p">=</span> <span class="nc">TEXT_PLAIN</span><span class="p">,</span>
        <span class="n">message</span> <span class="p">=</span> <span class="s">"the new response has the Content-Type header"</span>
    <span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span>
        <span class="n">actual</span> <span class="p">=</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">LINK</span><span class="p">(</span><span class="n">responseWithHeaders</span><span class="p">),</span>
        <span class="n">expected</span> <span class="p">=</span> <span class="nf">mapOf</span><span class="p">(</span><span class="s">"canonical"</span> <span class="n">to</span> <span class="nc">Uri</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="s">"/hello"</span><span class="p">)),</span>
        <span class="n">message</span> <span class="p">=</span> <span class="s">"the new response has the Location header"</span>
    <span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Together <code>with</code> and <code>of</code> make code that uses lenses to set values easier to read. If we used lenses as functions in our code, we would end up with deeply nested function calls and lots of parentheses. Using <code>with</code> and <code>of</code> we avoid all the parentheses and our code refers to the lenses and values in an order that reads more naturally.</p>
</div>
</div>
<div class="sect2">
<h3 id="_defining_a_new_header_lens">5.3. Defining a New Header Lens</h3>
<div class="paragraph">
<p>Let&#8217;s also signal that our app&#8217;s greeting is in English by sending the Content-Language response header.
Here&#8217;s our test extended to include the behaviour we want:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="nf">everyone`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>That test doesn&#8217;t even compile.  http4k doesn&#8217;t have a lens for the Content-Language header. We will need to write it ourselves.</p>
</div>
<div class="paragraph">
<p>We could define it as a top-level constant in our app, but http4k&#8217;s naming convention is to group lenses by the part of the HttpMessage that they refer to: Body, Header, Path, Query, etc.
If we are working in a team, or publishing a library, following this convention will help other developers find our new lens with autocomplete in the IDE.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="chapters/autocomplete-including-custom-lens.png" alt="Autocomplete includes our custom header lens">
</div>
</div>
<div class="paragraph">
<p>We can follow http4k&#8217;s naming convention by writing our lens as extension of the Header object.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nc">Locale</span><span class="o">::</span><span class="n">forLanguageTag</span><span class="p">,</span> <span class="nc">Locale</span><span class="o">::</span><span class="n">toLanguageTag</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">optional</span><span class="p">(</span><span class="s">"content-language"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As well as being a scope for header lenses, the Header object is a partially defined lens that represents some value of type String within the headers of an HttpMessage.  Partially defined, because to be a fully defined lens that targets a specific header, it needs the name of the header. This is what the call to <code>optional</code> does.  The <code>map</code> method turns the (partially defined) lens for a String into a lens for a Locale by mapping in both directions between String and Locale. The mapping is defined by two functions.  The function of type <code>(String)&#8594;Locale</code> is used when getting the header value.  The function of <code>(Locale)&#8594;String</code> is used when setting the header value.</p>
</div>
<div class="paragraph">
<p>My brain finds that http4k&#8217;s lens declarations read backwards. I would find an API like <code>Header.named("content-language").map(&#8230;&#8203;).optional()</code> easier to understand, but the API is what it is, and it works. As an author I struggle to explain it well (sorry about that!), but as a developer I can define new types of lens very easily and succinctly. And when you use http4k, you define new lenses a <em>lot</em>!</p>
</div>
<div class="paragraph">
<p>With the definition of the CONTENT_LANGUAGE lens, our test compiles, and now fails as we expect:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">HelloWorldTest &gt; returns hello everyone() FAILED
org.opentest4j.AssertionFailedError: expected: &lt;en&gt; but was: &lt;null&gt;
	at app//learnhttp4kwithtests.HelloWorldTest.returns hello everyone(HelloWorldTest.kt:21)</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can make it pass by using the lens to set the header value in the <code>with</code> call in our main app:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span><span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span>
            <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">,</span>
            <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="n">of</span> <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And now our test passes.</p>
</div>
<div class="paragraph">
<p>We can make a small optimisation, to avoid constructing a new lens value every time we refer to it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">private</span> <span class="kd">val</span> <span class="py">contentLanguageLens</span> <span class="p">=</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nc">Locale</span><span class="o">::</span><span class="n">forLanguageTag</span><span class="p">,</span> <span class="nc">Locale</span><span class="o">::</span><span class="n">toLanguageTag</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">optional</span><span class="p">(</span><span class="s">"content-language"</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="k">get</span><span class="p">()</span> <span class="p">=</span> <span class="n">contentLanguageLens</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our test still passes.</p>
</div>
<div class="paragraph">
<p>And the Kotlin compiler will generate the backing field and getter function for us if we define the extension using property delegation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="k">by</span> <span class="nf">lazyOf</span><span class="p">(</span>
    <span class="nc">Header</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nc">Locale</span><span class="o">::</span><span class="n">forLanguageTag</span><span class="p">,</span> <span class="nc">Locale</span><span class="o">::</span><span class="n">toLanguageTag</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">optional</span><span class="p">(</span><span class="s">"content-language"</span><span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>lazyOf</code> function in Kotlin&#8217;s standard library actually creates a property delegate for an eagerly constructed value!
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This is the most concise and efficient way I know to define extension properties, so we&#8217;ll use this idiom for any more that we need.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="routing">6. Routing</h2>
<div class="sectionbody">
<div class="paragraph">
<p>So far our application ignores the request.  This means that a client can get any URL and get the same text.  In real apps, we need to serve different resources on different URLs and perform different actions depending on the HTTP method and other properties of the request. In http4k, this is done by <em>routing</em> each request to a handler that can serve it.</p>
</div>
<div class="paragraph">
<p>In this chapter we extend our Hello World application to serve greetings in different languages on different paths.  We will serve the existing behaviour from a route "/hello/en", and add "/hello/fr" for French, "/hello/de" for German, and so on.  Our paths will use standard ISO 639-1 language codes to identify each language, so we don&#8217;t have to invent our own identifier scheme.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by changing our test to check that we can get the English greeting on the "/hello/en" path.  This test should pass because our app&#8217;s handler does not depend on any properties of the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="k">in</span> <span class="nc">English`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello/en"</span><span class="p">))</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>As expected, the test passes.</p>
</div>
<div class="paragraph">
<p>Now let&#8217;s add a test that the app <em>also</em> serves the greeting in French on the path "/hello/fr".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="k">in</span> <span class="nc">French`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello/fr"</span><span class="p">))</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"bonjour tout le monde"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">FRENCH</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test for English still passes and the test for French fails as expected:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">HelloWorldTest &gt; returns hello in French() FAILED
org.opentest4j.AssertionFailedError: expected: &lt;bonjour tout le monde&gt; but was: &lt;hello everyone&gt;
	at app//learnhttp4kwithtests.HelloWorldTest.returns hello in French(HelloWorldTest.kt:32)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to make our app route requests to different handler behaviour based on the value of the path.</p>
</div>
<div class="sect2">
<h3 id="_routing_requests_to_handlers">6.1. Routing Requests to Handlers</h3>
<div class="paragraph">
<p>http4k builds routing rules with the routes function that returns an HttpHandler that chooses which of a collection of handlers should receive each request. The most common routing criteria is by path and method, but http4k can route by path, query parameters, method, header values, and body content.  The routing criteria is defined by â€” you guessed it â€” functions, so you can write your own criteria if your application needs more sophisticated routing.</p>
</div>
<div class="paragraph">
<p>It&#8217;s easier to explain with an example. We&#8217;ll follow the "copy/paste/refactor" method of extending the app: create a router, copy/paste the existing handler to add more routes, change the new handlers to make the test pass, and then refactor away whatever duplication we created to discover abstractions that better express what the app is doing.  Here&#8217;s the first step:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span><span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="nf">routes</span><span class="p">(</span>
    <span class="s">"/hello/en"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
        <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">with</span><span class="p">(</span>
                <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">,</span>
                <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="n">of</span> <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="s">"/hello/fr"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
        <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">with</span><span class="p">(</span>
                <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">,</span>
                <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="n">of</span> <span class="nc">Locale</span><span class="p">.</span><span class="nc">FRENCH</span>
            <span class="p">)</span>
            <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"bonjour tout le monde"</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>What varies between each handler is the text and the language identifier that are returned in the response. We can extract a common function for creating the response used by all the handlers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span><span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="nf">routes</span><span class="p">(</span>
    <span class="s">"/hello/en"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span><span class="p">,</span> <span class="s">"hello everyone"</span><span class="p">)</span> <span class="p">},</span>
    <span class="s">"/hello/fr"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">FRENCH</span><span class="p">,</span> <span class="s">"bonjour tout le monde"</span><span class="p">)</span> <span class="p">}</span>
<span class="p">)</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="n">language</span><span class="p">:</span> <span class="nc">Locale</span><span class="p">,</span> <span class="n">text</span><span class="p">:</span> <span class="nc">String</span><span class="p">)</span> <span class="p">=</span>
    <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span>
            <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">,</span>
            <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span> <span class="n">of</span> <span class="n">language</span>
        <span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="n">text</span><span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_extracting_values_from_a_request">6.2. Extracting Values from a Request</h3>
<div class="paragraph">
<p>There&#8217;s still some duplication between the language identifier in the path and the language identifier returned in the response.  There&#8217;s a risk we could introduce bugs by getting them out of sync, and that means more testing effort to ensure we don&#8217;t.  We can address that by making the app more data-driven and having it work from a mapping of language to greeting, like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">private</span> <span class="kd">val</span> <span class="py">greetings</span> <span class="p">=</span> <span class="nf">mapOf</span><span class="p">(</span>
    <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span> <span class="n">to</span> <span class="s">"hello everyone"</span><span class="p">,</span>
    <span class="nc">Locale</span><span class="p">.</span><span class="nc">FRENCH</span> <span class="n">to</span> <span class="s">"bonjour tout le monde"</span><span class="p">,</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We will replace our app&#8217;s language-specific routes with a single route whose handler will parse the language identifier from the path of the request and use it to look up the text to return.</p>
</div>
<div class="paragraph">
<p>That&#8217;s quite a significant refactoring, and we risk changing the way our app reports errors when the client requests a language we do not support.  Let&#8217;s lock down that behaviour with an additional test before refactoring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`returns</span> <span class="nc">Not</span> <span class="nc">Found</span> <span class="k">if</span> <span class="n">language</span> <span class="n">not</span> <span class="nf">supported`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello/xx"</span><span class="p">))</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">NOT_FOUND</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To extract the language identifier from the path of the request we need a lens, like the Header.CONTENT_LANGUAGE lens we defined earlier, but that targets a path element of the request.  Lenses that target the path of a request are created from the Path object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">languageTag</span><span class="p">()</span> <span class="p">=</span> <span class="nf">map</span><span class="p">(</span><span class="nc">Locale</span><span class="o">::</span><span class="n">forLanguageTag</span><span class="p">,</span> <span class="nc">Locale</span><span class="o">::</span><span class="n">toLanguageTag</span><span class="p">)</span>

<span class="kd">val</span> <span class="py">language</span> <span class="p">=</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">languageTag</span><span class="p">().</span><span class="nf">of</span><span class="p">(</span><span class="s">"language"</span><span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The conventions for the Path object are somewhat different to the Header object. Path defines a large number of factory functions for create different types of lens, but not any actual lenses:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">string</span><span class="p">()</span> <span class="p">=</span> <span class="k">this</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">nonEmptyString</span><span class="p">()</span> <span class="p">=</span> <span class="nf">map</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">nonEmpty</span><span class="p">())</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">nonBlankString</span><span class="p">()</span> <span class="p">=</span> <span class="nf">map</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">nonBlank</span><span class="p">())</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">int</span><span class="p">()</span> <span class="p">=</span> <span class="nf">mapWithNewMeta</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">int</span><span class="p">(),</span> <span class="nc">IntegerParam</span><span class="p">)</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">long</span><span class="p">()</span> <span class="p">=</span> <span class="nf">mapWithNewMeta</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">long</span><span class="p">(),</span> <span class="nc">IntegerParam</span><span class="p">)</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">double</span><span class="p">()</span> <span class="p">=</span> <span class="nf">mapWithNewMeta</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">double</span><span class="p">(),</span> <span class="nc">NumberParam</span><span class="p">)</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">float</span><span class="p">()</span> <span class="p">=</span> <span class="nf">mapWithNewMeta</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">float</span><span class="p">(),</span> <span class="nc">NumberParam</span><span class="p">)</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">bigInteger</span><span class="p">()</span> <span class="p">=</span> <span class="nf">mapWithNewMeta</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">bigInteger</span><span class="p">(),</span> <span class="nc">IntegerParam</span><span class="p">)</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">bigDecimal</span><span class="p">()</span> <span class="p">=</span> <span class="nf">mapWithNewMeta</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">bigDecimal</span><span class="p">(),</span> <span class="nc">NumberParam</span><span class="p">)</span>
<span class="k">fun</span> <span class="nc">Path</span><span class="p">.</span><span class="nf">boolean</span><span class="p">()</span> <span class="p">=</span> <span class="nf">mapWithNewMeta</span><span class="p">(</span><span class="nc">StringBiDiMappings</span><span class="p">.</span><span class="nf">boolean</span><span class="p">(),</span> <span class="nc">BooleanParam</span><span class="p">)</span>
<span class="o">..</span><span class="p">.</span> <span class="n">etc</span><span class="p">.</span> <span class="n">etc</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Applications use these factory functions to define the lenses for their URL paths. Http4k does not define a lens for language tags, so we have to define our own and use it to define a path lens.</p>
</div>
<div class="paragraph">
<p>We can use the lens to define a path template that http4k&#8217;s routing will use to parse the language tag out of the path as it routes the request:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">val</span> <span class="py">app</span><span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="nf">routes</span><span class="p">(</span>
    <span class="s">"/hello/${language}"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
        <span class="kd">val</span> <span class="py">lang</span> <span class="p">=</span> <span class="nf">language</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">text</span> <span class="p">=</span> <span class="n">greetings</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>

        <span class="k">when</span> <span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">null</span> <span class="p">-&gt;</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">NOT_FOUND</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">-&gt;</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Our tests still all pass.</p>
</div>
<div class="paragraph">
<p>And now we can easily support more languages by adding them to the map, without touching the HTTP layer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">private</span> <span class="kd">val</span> <span class="py">greetings</span> <span class="p">=</span> <span class="nf">mapOf</span><span class="p">(</span>
    <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span> <span class="n">to</span> <span class="s">"hello everyone"</span><span class="p">,</span>
    <span class="nc">Locale</span><span class="p">.</span><span class="nc">FRENCH</span> <span class="n">to</span> <span class="s">"bonjour tout le monde"</span><span class="p">,</span>
    <span class="nc">Locale</span><span class="p">.</span><span class="nc">GERMAN</span> <span class="n">to</span> <span class="s">"hallo zusammen"</span><span class="p">,</span>
    <span class="nc">Locale</span><span class="p">.</span><span class="nc">CANADA_FRENCH</span> <span class="n">to</span> <span class="s">"allÃ´ a tous, hein?"</span><span class="p">,</span>
<span class="p">)</span></code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_routing_different_methods_to_a_resource">6.3. Routing different methods to a resource</h3>
<div class="paragraph">
<p>So far our app only routes by path. Web applications also have to support other HTTP methods.
To explore routing by method, let&#8217;s allow clients to set and remove the greeting text for each language by using the PUT and DELETE methods.  For now, we will ignore security. We&#8217;ll look at authentication and authorisation in http4k in <a href="#authentication">Chapter 16, <em>OAuth, Authentication and Authorisation</em></a> and pretend it is being handled by a service mesh for the time being!  And we&#8217;ll continue to store the greetings in memory.  We look at database persistence in <a href="#persistence">Chapter 12, <em>Persistence and transactions</em></a>, but will use a mutable map for the time being.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s start by writing a test.  If the app can change the state of the map, we now need to make sure that tests are isolated from one another. Each test needs to start the application with its own map instance, initialised to a known state.  That means the app cannot be a global <em>value</em> that depends on the map as a global variable. It must be created by, you guessed it, a function, that takes the map of greetings as a parameter.</p>
</div>
<div class="paragraph">
<p>IntelliJ can perform this transformation as a sequence of small refactorings in a few keystrokes. If you&#8217;re following along in the Git repository, you&#8217;ll see that&#8217;s how we did the transformation ourselves. But this is a book about learning http4k, not refactoring techniques, so we can jump to the end result.</p>
</div>
<div class="paragraph">
<p>Our test class instantiates the greetings map and app for each test:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldTest</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">greetings</span> <span class="p">=</span> <span class="nf">mutableMapOf</span><span class="p">(</span>
        <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span> <span class="n">to</span> <span class="s">"hello everyone"</span><span class="p">,</span>
        <span class="nc">Locale</span><span class="p">.</span><span class="nc">FRENCH</span> <span class="n">to</span> <span class="s">"bonjour tout le monde"</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="kd">val</span> <span class="py">app</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="n">greetings</span><span class="p">)</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`returns</span> <span class="n">hello</span> <span class="k">in</span> <span class="nc">English`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello/en"</span><span class="p">))</span>

        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"hello everyone"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">())</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">TEXT_PLAIN</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_LANGUAGE</span><span class="p">(</span><span class="n">response</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="o">..</span><span class="p">.</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The greetings map no longer needs to be global. The main method can declare it as a local variable, which guarantees that our app logic only refers to it through the parameter of the app function. It creates a ConcurrentHashMap to ensure thread safety because the Jetty server that serves our app spawns multiple threads:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">greetings</span> <span class="p">=</span> <span class="nc">ConcurrentHashMap</span><span class="p">(</span><span class="nf">mapOf</span><span class="p">(</span>
        <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span> <span class="n">to</span> <span class="s">"hello everyone"</span><span class="p">,</span>
        <span class="nc">Locale</span><span class="p">.</span><span class="nc">FRENCH</span> <span class="n">to</span> <span class="s">"bonjour tout le monde"</span><span class="p">,</span>
        <span class="nc">Locale</span><span class="p">.</span><span class="nc">GERMAN</span> <span class="n">to</span> <span class="s">"hallo zusammen"</span><span class="p">,</span>
        <span class="nc">Locale</span><span class="p">.</span><span class="nc">CANADA_FRENCH</span> <span class="n">to</span> <span class="s">"allÃ´ a tous, hein?"</span><span class="p">,</span>
    <span class="p">))</span>

    <span class="nf">app</span><span class="p">(</span><span class="n">greetings</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">asServer</span><span class="p">(</span><span class="nc">JettyLoom</span><span class="p">(</span><span class="n">port</span> <span class="p">=</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">.</span><span class="nf">start</span><span class="p">()</span>
        <span class="p">.</span><span class="nf">also</span> <span class="p">{</span>
            <span class="nf">println</span><span class="p">(</span><span class="s">"http://localhost:${it.port()}"</span><span class="p">)</span>
        <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now write a test for adding a new greeting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`can</span> <span class="n">put</span> <span class="n">a</span> <span class="n">greeting</span> <span class="k">for</span> <span class="n">a</span> <span class="nf">language`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">putResponse</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">PUT</span><span class="p">,</span> <span class="s">"/hello/it"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="nc">Header</span><span class="p">.</span><span class="nc">CONTENT_TYPE</span> <span class="n">of</span> <span class="nc">TEXT_PLAIN</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">body</span><span class="p">(</span><span class="s">"ciao a tutti"</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">putResponse</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"ciao a tutti"</span><span class="p">,</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello/it"</span><span class="p">)).</span><span class="nf">bodyString</span><span class="p">())</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We expect this test to fail because our app doesn&#8217;t yet handle the PUT method, and it does:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">HelloWorldTest &gt; can put a greeting for a language() FAILED
org.opentest4j.AssertionFailedError: expected: &lt;200 OK&gt; but was: &lt;405 Method Not Allowed&gt;
	at app//learnhttp4kwithtests.HelloWorldTest.can put a greeting for a language(HelloWorldTest.kt:65)</code></pre>
</div>
</div>
<div class="paragraph">
<p>And now we can extend our app to define the behaviour for the PUT method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nf">app</span><span class="p">(</span><span class="n">greetings</span><span class="p">:</span> <span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="nf">routes</span><span class="p">(</span>
    <span class="s">"/hello/${language}"</span> <span class="n">bind</span> <span class="nf">routes</span><span class="p">(</span>
        <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
            <span class="kd">val</span> <span class="py">lang</span> <span class="p">=</span> <span class="nf">language</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">text</span> <span class="p">=</span> <span class="n">greetings</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>

            <span class="k">when</span> <span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">null</span> <span class="p">-&gt;</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">NOT_FOUND</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">-&gt;</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">},</span>
        <span class="nc">PUT</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
            <span class="kd">val</span> <span class="py">lang</span> <span class="p">=</span> <span class="nf">language</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="kd">val</span> <span class="py">text</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">bodyString</span><span class="p">()</span>

            <span class="n">greetings</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span> <span class="p">=</span> <span class="n">text</span>

            <span class="nc">Response</span><span class="p">(</span><span class="nc">OK</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">)</span>
<span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>We can add another test to specify how to remove a greeting:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`can</span> <span class="n">remove</span> <span class="n">a</span> <span class="n">greeting</span> <span class="k">for</span> <span class="n">a</span> <span class="nf">language`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">deleteResponse</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">DELETE</span><span class="p">,</span> <span class="s">"/hello/fr"</span><span class="p">))</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">OK</span><span class="p">,</span> <span class="n">deleteResponse</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">NOT_FOUND</span><span class="p">,</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello/fr"</span><span class="p">)).</span><span class="n">status</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And I&#8217;ll leave it as an exercise to make that pass, and also to write tests for other cases, such as overwriting an existing greeting, or deleting a greeting that does not exist.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="filters-and-stacks">7. Filters and stacks</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Implement "proactive content negotiation" via the Accept-Language header. The "/hello" path will select text based on client preferences.  For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`returns</span> <span class="n">best</span> <span class="n">available</span> <span class="n">language</span> <span class="k">by</span> <span class="n">content</span> <span class="nf">negotiation`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">languagePreferences</span> <span class="p">=</span> <span class="nc">PriorityList</span><span class="p">(</span>
        <span class="c1">// Prefer Welsh</span>
        <span class="nc">Exactly</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="s">"cy"</span><span class="p">))</span> <span class="n">q</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="c1">// but will grudgingly accept English</span>
        <span class="nc">Exactly</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span><span class="p">)</span> <span class="n">q</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="c1">// or whatever the server can provide, as a fallback.</span>
        <span class="nc">Wildcard</span> <span class="n">q</span> <span class="mf">0.25</span>
    <span class="p">)</span>

    <span class="kd">val</span> <span class="py">responseByNegotiation</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span>
        <span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello"</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">with</span><span class="p">(</span><span class="nc">Header</span><span class="p">.</span><span class="nc">ACCEPT_LANGUAGE</span> <span class="n">of</span> <span class="n">languagePreferences</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1">// Response should be the same as fetching English content explicitly but</span>
    <span class="c1">// with a Vary header reporting the content negotiation that occurred.</span>
    <span class="kd">val</span> <span class="py">expectedResponse</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello/en"</span><span class="p">))</span>
        <span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"vary"</span><span class="p">,</span> <span class="s">"accept-language"</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="n">expectedResponse</span><span class="p">,</span> <span class="n">responseByNegotiation</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the test depends on Responses being values and that we can compare them for equality.</p>
</div>
<div class="paragraph">
<p>And here&#8217;s what should happen when content negotiation does not find a language acceptable to the client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`reports</span> <span class="k">when</span> <span class="n">no</span> <span class="n">acceptable</span> <span class="n">language</span> <span class="k">is</span> <span class="nf">available`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">with</span><span class="p">(</span>
            <span class="nc">Header</span><span class="p">.</span><span class="nc">ACCEPT_LANGUAGE</span> <span class="n">of</span> <span class="nc">PriorityList</span><span class="p">(</span>
                <span class="nc">Exactly</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nf">of</span><span class="p">(</span><span class="s">"cy"</span><span class="p">))</span> <span class="n">q</span> <span class="mf">1.0</span><span class="p">,</span>
                <span class="nc">Exactly</span><span class="p">(</span><span class="nc">Locale</span><span class="p">.</span><span class="nc">ITALIAN</span><span class="p">)</span> <span class="n">q</span> <span class="mf">0.5</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">Status</span><span class="p">.</span><span class="nc">NOT_ACCEPTABLE</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="s">"accept-language"</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"vary"</span><span class="p">))</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following route implements content negotiation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="s">"/hello"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="kd">val</span> <span class="py">prefs</span> <span class="p">=</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">ACCEPT_LANGUAGE</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">selected</span><span class="p">:</span> <span class="nc">Locale</span><span class="p">?</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">prefs</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">null</span> <span class="p">-&gt;</span> <span class="nc">Locale</span><span class="p">.</span><span class="nc">ENGLISH</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="n">prefs</span><span class="p">.</span><span class="nf">preferred</span><span class="p">(</span><span class="n">greetings</span><span class="p">.</span><span class="n">keys</span><span class="p">.</span><span class="nf">toList</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="k">when</span> <span class="p">(</span><span class="n">selected</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">null</span> <span class="p">-&gt;</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">NOT_ACCEPTABLE</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="n">selected</span><span class="p">,</span> <span class="n">greetings</span><span class="p">.</span><span class="nf">getValue</span><span class="p">(</span><span class="n">selected</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="n">response</span>
        <span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"vary"</span><span class="p">,</span> <span class="nc">Header</span><span class="p">.</span><span class="nc">ACCEPT_LANGUAGE</span><span class="p">.</span><span class="n">meta</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
<span class="p">},</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You may be wondering, what happens if the Header.ACCEPT_LANGUAGE lens cannot parse the Accept-Language header.
Let&#8217;s write a test and see&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="nd">@Test</span>
<span class="k">fun</span> <span class="nf">`malformed</span> <span class="n">accept-language</span> <span class="nf">header`</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="s">"/hello"</span><span class="p">)</span>
        <span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"accept-language"</span><span class="p">,</span> <span class="s">"en;q=xxx"</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">BAD_REQUEST</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test fails with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">HelloWorldTest &gt; malformed accept-language header() FAILED
org.http4k.lens.LensFailure: header 'accept-language' must be priority list of language
Caused by: java.lang.NumberFormatException: For input string: "xxx"</code></pre>
</div>
</div>
<div class="paragraph">
<p>If any of the functions that define a lens throws an exception, http4k wraps that exception in a LensFailure and rethrows it. In the test, the exception propagates up to JUnit, which reports it as a test failure.</p>
</div>
<div class="paragraph">
<p>What happens in a running application?  Let&#8217;s write a test and see&#8230;&#8203;</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="kd">class</span> <span class="nc">HelloWorldIntegrationTest</span> <span class="p">{</span>
    <span class="kd">val</span> <span class="py">app</span><span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="nf">app</span><span class="p">(</span><span class="nf">mutableMapOf</span><span class="p">())</span>

    <span class="kd">val</span> <span class="py">server</span> <span class="p">=</span> <span class="n">app</span><span class="p">.</span><span class="nf">asServer</span><span class="p">(</span><span class="nc">JettyLoom</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
    <span class="kd">val</span> <span class="py">url</span> <span class="k">by</span> <span class="nf">lazy</span> <span class="p">{</span> <span class="s">"http://localhost:${server.port()}/hello"</span> <span class="p">}</span>

    <span class="kd">val</span> <span class="py">client</span><span class="p">:</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="nc">JavaHttpClient</span><span class="p">()</span>

    <span class="nd">@BeforeEach</span>
    <span class="k">fun</span> <span class="nf">startServer</span><span class="p">()</span> <span class="p">{</span> <span class="n">server</span><span class="p">.</span><span class="nf">start</span><span class="p">()</span> <span class="p">}</span>

    <span class="nd">@AfterEach</span>
    <span class="k">fun</span> <span class="nf">stopServer</span><span class="p">()</span> <span class="p">{</span> <span class="n">server</span><span class="p">.</span><span class="nf">stop</span><span class="p">()</span> <span class="p">}</span>

    <span class="nd">@Test</span>
    <span class="k">fun</span> <span class="nf">`testing</span> <span class="n">lens</span> <span class="nf">failure`</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">val</span> <span class="py">request</span> <span class="p">=</span> <span class="nc">Request</span><span class="p">(</span><span class="nc">GET</span><span class="p">,</span> <span class="n">url</span><span class="p">)</span>
            <span class="p">.</span><span class="nf">header</span><span class="p">(</span><span class="s">"accept-language"</span><span class="p">,</span> <span class="s">"en;q=xxx"</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">response</span> <span class="p">=</span> <span class="nf">client</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="nf">assertEquals</span><span class="p">(</span><span class="nc">BAD_REQUEST</span><span class="p">,</span> <span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The test creates an HTTP server and client. This is the first time we&#8217;ve created an HTTP client. In http4k}, a client is an HttpHandler! To write an app, we <em>implement</em> an HttpHandler that receives a Request and returns a Response.  To use a client, we <em>call</em> an  HttpHandler, passing in a Request and getting a Response as a result. We look at HTTP clients in more detail in <a href="#http-clients">Chapter 13, <em>HTTP Clients</em></a>.</p>
</div>
<div class="paragraph">
<p>The integration test fails with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="text">HelloWorldIntegrationTest &gt; testing lens failure() FAILED
org.opentest4j.AssertionFailedError: expected: &lt;400 Bad Request&gt; but was: &lt;500 &gt;
	at app//learnhttp4kwithtests.HelloWorldIntegrationTest.testing lens failure(HelloWorldIntegrationTest.kt:35)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last-ditch exception handler in the server runtime catches the LensFailure thrown from our app and returns a 500 Internal Server Error response to the client. This is not correct: the malformed request is the fault of the client, not the server. The response should be 400 Bad Request. If our app reports an internal server error when a client sends a bad request, a faulty client will keep retrying the request, alerting the engineers on support duty and adding load to our system. Our application must therefore catch LensFailure exceptions and translate them to the correct response status code.</p>
</div>
<div class="paragraph">
<p>Now, we don&#8217;t want to duplicate that try/catch code in every handler in our application. The solution in http4k is <em>filters</em>, and specifically the CatchLensFailure filter.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s look at the filter in use, and then examine what the code is doing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nf">app</span><span class="p">(</span><span class="n">greetings</span><span class="p">:</span> <span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">HttpHandler</span> <span class="p">=</span>
    <span class="nc">ServerFilters</span><span class="p">.</span><span class="nc">CatchLensFailure</span><span class="p">(</span><span class="nf">greetingRoutes</span><span class="p">(</span><span class="n">greetings</span><span class="p">))</span>

<span class="k">private</span> <span class="k">fun</span> <span class="nf">greetingRoutes</span><span class="p">(</span><span class="n">greetings</span><span class="p">:</span> <span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;)</span> <span class="p">=</span>
    <span class="nf">routes</span><span class="p">(</span>
        <span class="s">"/hello"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
            <span class="o">..</span><span class="p">.</span>
        <span class="p">},</span>
        <span class="s">"/hello/${language}"</span> <span class="n">bind</span> <span class="nf">routes</span><span class="p">(</span>
            <span class="o">..</span><span class="p">.</span>
        <span class="p">)</span>
    <span class="p">)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>I&#8217;ve refactored the routes out of the app into its own function, so that it&#8217;s easier to see how the filter is applied.</p>
</div>
<div class="paragraph">
<p>A filter is a higher-order function of HttpHandler to HttpHandler. It takes an HttpHandler â€“ let&#8217;s call it the "next handler" â€“ and returns a new HttpHander that delegates to the next handler, and can perform behaviour before or after the call to the next handler.</p>
</div>
<div class="paragraph">
<p>The handler created by the CatchLensFailure filter wraps the call to the next handler in a try/catch block that catches LensFailure exceptions and returns a Response with a 400 Bad Request status code. There are various factory functions for CatchLensFailure that give you control over how the exception is translated into a response, but the default is good enough for our needs.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The LensFailure exception is a design compromise. The type declarations for lenses and the developer experience of using lenses would much more complicated if errors had to be represented in the type of the lens. Therefore, Dave and Ivan took a pragmatic decision to report failures from lenses with exceptions instead of return types. In practice, it works fine despite exceptions not being type checked because the translation is performed in one place, the CatchLensFailure filter, instead of duplicated in every handler.
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_other_useful_filters">7.1. Other Useful Filters</h3>
<div class="paragraph">
<p>The handler created by a Filter can modify the request before passing it to the next handler or modify the response from the next handler before returning the response to its caller. It can shortcut request handling by returning a response without ever passing the request to the next handler. It can catch exceptions thrown by the next handler and translate them into responses. Anything a higher-order function can do, a filter can do, because a filter is just a higher-order function.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
Filter is defined as a <code>fun interface</code>, not as a function type.  That means you can call a Filter with function call syntax, but not pass it to code that expects a value of a function type. I&#8217;ve no idea why Filter is declared this way, but it&#8217;s not possible to change the declaration to a typealias of a function tyoe without breaking lots of code, so a <code>fun interface</code> it has to stay.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>http4k comes with an abundance of useful filters.  Among them:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CatchAll</code> catches any exception and translates it into a Response, usually with status 500 Internal Service Error, so that your app can control the representation of errors sent to the client.</p>
</li>
<li>
<p><code>ReportHttpTransaction</code> reports incoming or outgoing requests and responses for observability.</p>
</li>
<li>
<p><code>RequestTimer</code> and <code>RequestCounter</code> record metrics.</p>
</li>
<li>
<p><code>Cors</code> sets headers for cross-origin resource sharing</p>
</li>
<li>
<p><code>RequestTracing</code> adds headers for distributed tracing between services.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each filter implements one aspect of request processing.  An application composes them together to define the request processing that it needs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Composing filters into stacks</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A typical application stack looks like this:</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="chapters/server-filter-stack.drawio.svg" alt="Server filter stack"></span></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Server runtime, to receive requests and send responses</p>
</li>
<li>
<p>Debugging, to ensure that we see all traffic during development</p>
</li>
<li>
<p>Tracing, to trace requests between services and associate log events to traces</p>
</li>
<li>
<p>Recording metrics, to track how long request processing took</p>
</li>
<li>
<p>Reporting traffic, to record accurately what we sent back to the client</p>
</li>
<li>
<p>Catching unexpected exceptions, to ensure that error responses are controlled by the application</p>
</li>
<li>
<p>Catching expected exceptions, for instance LensFailures which are converted to 400s</p>
</li>
<li>
<p>The application:</p>
<div class="ulist">
<ul>
<li>
<p>Routing, to route traffic to the handler that can process the traffic</p>
</li>
<li>
<p>HttpHandlers, to process the traffic</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_writing_a_filter">7.2. Writing a filter</h3>
<div class="paragraph">
<p>TBD</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="application-structure">8. Http4k Application Structure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our trivial Hello World application has grown to have the typical top-level structure of an http4k application.</p>
</div>
<div class="paragraph">
<p>The <code>app</code> factory function creates the HttpHandlers of the application and defines the routing of requests to those handlers.  The factory function is parameterised by the resources that the application requires: the mutable map of greetings. Operational aspects are composed into the app by a filter stack. The main function initialises the resources, passes them to the factory function to creates the HttpHandler, composes operation aspects into the app via Filters, and starts a Server to run the app.</p>
</div>
<div class="paragraph">
<p>However, as we&#8217;ve been building the app, we&#8217;ve written everything in one source file, and all the app&#8217;s handlers in a single function.  That source file is now quite large, and the routes function likewise is too long.  It&#8217;s hard to read: the routing rules do not fit on the screen of my laptop.  If we were working in a team, we would get frequent merge conflicts as team members all make changes to the same function.</p>
</div>
<div class="paragraph">
<p>We can split the source into separate files: <code>routes.kt</code> for the app routing and handlers, <code>stack.kt</code> for the filter stack, and <code>main.kt</code> for the app and main function that compose it all together.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="chapters/separate-source-files.png" alt="Organising the app into separate files">
</div>
</div>
<div class="paragraph">
<p>We can also extract each handler into its own top-level function.  HttpHandlers are just functions, so this is quick to do with IntelliJ&#8217;s <em>Extract Function to Scope</em> refactoring, and easy to reverse with IntelliJ&#8217;s <em>Inline</em> refactoring if we don&#8217;t like the result. The fast tests will let us quickly confirm that our refactoring has not changed our application&#8217;s behaviour.</p>
</div>
<div class="paragraph">
<p>There are a couple of structures we can refactor to.  Let&#8217;s try them both.</p>
</div>
<div class="paragraph">
<p>We could factor out each <em>route</em> as a top-level function, composed together in the app-level <code>greetingRoutes</code> function.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nf">greetingRoutes</span><span class="p">(</span><span class="n">greetings</span><span class="p">:</span> <span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;)</span> <span class="p">=</span> <span class="nf">routes</span><span class="p">(</span>
    <span class="nf">getPreferredGreetingRoute</span><span class="p">(</span><span class="n">greetings</span><span class="p">),</span>
    <span class="nf">getGreetingRoute</span><span class="p">(</span><span class="n">greetings</span><span class="p">),</span>
    <span class="nf">putGreetingRoute</span><span class="p">(</span><span class="n">greetings</span><span class="p">),</span>
    <span class="nf">deleteGreetingRoute</span><span class="p">(</span><span class="n">greetings</span><span class="p">)</span>
<span class="p">)</span>

<span class="o">..</span><span class="p">.</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">getGreetingRoute</span><span class="p">(</span><span class="n">greetings</span><span class="p">:</span> <span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">RoutingHttpHandler</span> <span class="p">=</span>
    <span class="s">"/hello/${language}"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="nf">to</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
        <span class="kd">val</span> <span class="py">lang</span> <span class="p">=</span> <span class="nf">language</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="kd">val</span> <span class="py">text</span> <span class="p">=</span> <span class="n">greetings</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>

        <span class="k">when</span> <span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">null</span> <span class="p">-&gt;</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">NOT_FOUND</span><span class="p">)</span>
            <span class="k">else</span> <span class="p">-&gt;</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

<span class="o">..</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This has the benefit that the path and the lenses used to extract parameters from the path are in the same scope. However, the path ends up duplicated in the functions <code>getGreetingRoute</code>, <code>putGreetingRoute</code> and <code>deleteGreetingRoute</code>.</p>
</div>
<div class="paragraph">
<p>Alternatively, we could factor out each <em>handler</em> as a top-level function, leaving the routes defined together in the <code>greetingRoutes</code> function.  Now we have to pass the lens used extract the language tag from the path into the handler to avoid too much connascence between the <code>greetingRoutes</code> function and each handler.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="kotlin"><span class="k">fun</span> <span class="nf">greetingRoutes</span><span class="p">(</span><span class="n">greetings</span><span class="p">:</span> <span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;):</span> <span class="nc">RoutingHttpHandler</span> <span class="p">=</span>
    <span class="nf">routes</span><span class="p">(</span>
        <span class="s">"/hello"</span> <span class="n">bind</span> <span class="nc">GET</span> <span class="n">to</span> <span class="nf">getPreferredGreetingHandler</span><span class="p">(</span><span class="n">greetings</span><span class="p">),</span>
        <span class="s">"/hello/${language}"</span> <span class="n">bind</span> <span class="nf">routes</span><span class="p">(</span>
            <span class="nc">GET</span> <span class="n">to</span> <span class="nf">getGreetingHandler</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">greetings</span><span class="p">),</span>
            <span class="nc">PUT</span> <span class="n">to</span> <span class="nf">putGreetingHandler</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">greetings</span><span class="p">),</span>
            <span class="nc">DELETE</span> <span class="n">to</span> <span class="nf">deleteGreetingHandler</span><span class="p">(</span><span class="n">language</span><span class="p">,</span> <span class="n">greetings</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="o">..</span><span class="p">.</span>
<span class="k">private</span> <span class="k">fun</span> <span class="nf">getGreetingHandler</span><span class="p">(</span>
    <span class="n">language</span><span class="p">:</span> <span class="nc">PathLens</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">&gt;,</span>
    <span class="n">greetings</span><span class="p">:</span> <span class="nc">MutableMap</span><span class="p">&lt;</span><span class="nc">Locale</span><span class="p">,</span> <span class="nc">String</span><span class="p">&gt;</span>
<span class="p">):</span> <span class="nc">HttpHandler</span> <span class="p">=</span> <span class="p">{</span> <span class="n">request</span> <span class="p">-&gt;</span>
    <span class="kd">val</span> <span class="py">lang</span> <span class="p">=</span> <span class="nf">language</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="kd">val</span> <span class="py">text</span> <span class="p">=</span> <span class="n">greetings</span><span class="p">[</span><span class="n">lang</span><span class="p">]</span>

    <span class="k">when</span> <span class="p">(</span><span class="n">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">null</span> <span class="p">-&gt;</span> <span class="nc">Response</span><span class="p">(</span><span class="nc">NOT_FOUND</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">-&gt;</span> <span class="nf">greetingResponse</span><span class="p">(</span><span class="n">lang</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="o">..</span><span class="p">.</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Personally, I prefer the second approach. It lets me see all the app&#8217;s routes in one place, and I can write exhaustive unit tests for the behaviour of each handler independently of the routing, if I need to.  If the application gets so large that a single routes function becomes impractical, I organise the routes into separate functions that each create the routes for one type of resource.</p>
</div>
</div>
</div>
<h1 id="realistic" class="sect0">II: Production Applications</h1>
<div class="sect1">
<h2 id="functional-test">9. Writing a Functional Test</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>The application domain: auctions</p>
</li>
<li>
<p>Architecture</p>
</li>
<li>
<p>HTTP service</p>
</li>
<li>
<p>Simplifying assumptions</p>
</li>
<li>
<p>Assume a service mesh</p>
</li>
<li>
<p>Blind auctions</p>
</li>
<li>
<p>Walking skeleton</p>
</li>
<li>
<p>Acceptance test - strategy - either write the test you want to see or write anything and refactor as you go. Weâ€™ll do the latter because we want to focus on learning http4k.</p>
</li>
<li>
<p>Write an acceptance test for the happy-path flow we want to implement</p>
</li>
<li>
<p>Create a new auction</p>
</li>
<li>
<p>fetch details of an auction</p>
</li>
<li>
<p>Bid in an auction</p>
</li>
<li>
<p>Close the auction and choose a winner</p>
</li>
<li>
<p>Hand-code the json</p>
</li>
<li>
<p>That gives us a failing test. We can use that test to track progress as we implement the happy path</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="json">10. JSON serialisation</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Choosing a marshaller</p>
</li>
<li>
<p>Body lenses for json serde</p>
</li>
<li>
<p>We will autocomplete declarations we need into existence and move them into appropriate packages as the system grows</p>
</li>
<li>
<p>Forkhandles: complementary libraries. Values4k for IDs.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuration">11. Configuration</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Configuration keys and lenses</p>
</li>
<li>
<p>Sources of configuration</p>
</li>
<li>
<p>Configuring the port number</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="persistence">12. Persistence and transactions</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Immutable domain model</p>
</li>
<li>
<p>Contract tests for persistence abstractions</p>
</li>
<li>
<p>In-memory implementation for testing</p>
</li>
<li>
<p>Postgres nosql implementation to demonstrate principle. Itâ€™ll do for now.</p>
</li>
<li>
<p>Testing the transactorâ€¦ off topic, leave as an exercise for the reader</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="http-clients">13. HTTP Clients</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Hand coded json is brittle and hard to evolve</p>
</li>
<li>
<p>We will write an http client for our tests, that maps from domain model to http transactions</p>
</li>
<li>
<p>Http4k Connect pattern</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="error-handling">14. Error handling</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Risks of error handling bugs - retry storms, etc.</p>
</li>
<li>
<p>Result4k vs exceptions. Result4k for when we want to write code to process the error â€” eg when we want to control the http status. Exceptions for technical errors, when the top-level error handling filter and 500 status is acceptable.</p>
</li>
<li>
<p>Railway oriented programming</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="monitoring">15. Monitoring and alerting</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Preventing and reporting shill bidding</p>
</li>
<li>
<p>Events and structured logging</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="authentication">16. OAuth, Authentication and Authorisation</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="background-tasks">17. Transactional outboxes and background tasks</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>English auctions</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="resilience">18. Resilience</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="contracts">19. Contracts and OpenAPI</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="frontend">20. Front End: HTML, HTMX, &amp; templates</h2>
<div class="sectionbody">

</div>
</div>
<div class="sect1">
<h2 id="multiservice">21. Multiservice applications</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Http client as a function</p>
</li>
<li>
<p>Tracing filters</p>
</li>
<li>
<p>Circuit breaker</p>
</li>
<li>
<p>Testing multiservice applications</p>
</li>
<li>
<p>Visualising test traces</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="streaming">22. File uploads and streaming content</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>E.g. upload/download product photos</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-evolution">23. API evolution</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Kondor: JSON formats as first class values</p>
</li>
<li>
<p>Different content types (json formats) mapped to the same domain objects</p>
</li>
<li>
<p>Content negotiation</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2025-09-08 19:01:08 +0100
</div>
</div>
</body>
</html>